---
title: Inferring socio-indexical features
author: Dave Kleinschmidt
---

```{r preamble, cache=FALSE, message=FALSE, warning=FALSE, error=FALSE}

library(ggplot2)
library(devtools)
load_all()

data('nsp_vows', package='nspvowels')

```


## Train models

```{r train-models}

dialect_models <- nsp_vows %>% group_by(Dialect) %>% train_models()

```


## Test models

### Get models in analogous form to Vowel classification

For each group, want a list of models whose names are the classes. In this case, the "group" is the whole dataset, each "model" is a list of single-vowel models, and the class is Dialect.

```{r list-models}

list_models <- function(d, model_field, group_field)
  set_names(d[[model_field]], d[[group_field]])

dialect_model_list <-
  dialect_models %>%
  do(models=list_models(., 'model', 'Vowel')) %>%
  list_models('models', 'Dialect')

names(dialect_model_list)
names(dialect_model_list[[1]])

```

### Calculate likelihood for each token

Now we need to apply each of the Dialect models to the data.

```{r test-models}

get_formants <- function(d)
  d %>%
    select_("F1", "F2") %>%
    as.matrix()

#' @param data data.frame with columns F1 and F2
#' @param mods vowel-space model (list of single-vowel models)
#' @return vector with marginal likelihood for each row in data.
marginal_model_lhood <- function(data, mods) {
  mods %>%
    map(~ model_lhood(., get_formants(data))) %>%
                                        # list of vowels lhood vectors
    do.call(rbind, .) %>%               # vowel x token matrix
    apply(., 2, mean)                   # marginal token lhoods
}


d <- nsp_vows %>% ungroup()

#' @param data data.frame with columns F1 and F2 (passed to marginal_model_lhood)
#' @param model_list list of models to calculate likelihood
#' @return data.frame of likelihoods, with one column per model, one row per row
#' in data
apply_models <- function(data, model_list) {
  model_list %>%
    map(~ marginal_model_lhood(data, .)) %>%
    ## do.call(rbind, .) %>%
    ## t() %>%                            # matrix with Dialect as cols
    as_data_frame()                       # data frame with Dialect as cols
}

lhoods <- apply_models(ungroup(nsp_vows), dialect_model_list)

```

```{r grouped-lhood, eval=FALSE}
## Wrap in a tbl_df (to accomodate grouping
data_frame(data=list(d), models=list(dialect_model_list)) %>%
  mutate(lhoods = map2(data, models, apply_models))
```

### Aggregate likelihoods across tokens for each talker

```{r aggregate-lhood}

posteriors <- lhoods %>%
  mutate(id_ = row_number()) %>%
  gather(model, lhood, -id_) %>%
  inner_join(d %>% mutate(id_ = row_number())) %>%
  group_by(id_) %>%
  mutate(posterior = lhood/sum(lhood))

posteriors %>%
  group_by(Talker, Dialect, model) %>%
  summarise(posterior = mean(posterior)) %>%
  filter(Dialect == model) %>%
  group_by(Dialect) %>%
  summarise(mean(posterior))

posteriors %>%
  group_by(Dialect, model) %>%
  summarise(posterior = mean(posterior)) %>%
  ggplot(aes(x=Dialect, y=model, fill=posterior)) +
  geom_tile()


```
